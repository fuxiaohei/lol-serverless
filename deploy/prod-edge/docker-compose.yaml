version: "3"

networks:
  runtime_land_edge_network:
    external: true

services:
  redis:
    image: redis:7.0.12-alpine
    restart: always
    command: redis-server --save 20 1 --loglevel warning --requirepass ${REDIS_PASSWORD}
    volumes:
      - ${REDIS_DIR}:/data
    networks:
      - runtime_land_edge_network
  proxy:
    image: traefik:3.0
    command: --api.insecure=true --providers.redis.endpoints=redis:6379 --providers.redis.password=${REDIS_PASSWORD} --providers.docker=true --providers.docker.exposedByDefault=false
    ports:
      - "80:80"
      # - "8080:8080" # traefik dashboard
    networks:
      - runtime_land_edge_network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - redis
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`${TRAEFIK_DASHBOARD_DOMAIN}`)"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth"
      - "traefik.http.services.dashboard.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_DASHBOARD_BASIC_AUTH}"
  land-edge:
    image: ghcr.io/fuxiaohei/runtime-land-edge:v0.1.0-b15
    restart: always
    environment:
      - HTTP_ADDR=${LAND_EDGE_HTTP_HOST}:${LAND_EDGE_HTTP_PORT}
      - CENTER_ADDR=${LAND_EDGE_CENTER_ADDR}
      - CENTER_TOKEN=${LAND_EDGE_CENTER_TOKEN}
      - STORAGE_LOCAL_PATH=${LAND_EDGE_STORAGE_LOCAL_PATH}
      - LOCAL_STORE_TYPE=local
      - REMOTE_STORE_TYPE=cloudflare-r2
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_BUCKET=${S3_BUCKET}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_ROOT_PATH=${S3_ROOT_PATH}
      - TRAEFIK_REDIS_ADDR=redis:6379
      - TRAEFIK_REDIS_PASSWORD=${REDIS_PASSWORD}
      - TRAEFIK_RUNTIME_NAME=${LAND_EDGE_RUNTIME_NAME}
    networks:
      - runtime_land_edge_network
  land-runtime:
    image: ghcr.io/fuxiaohei/runtime-land-runtime:v0.1.0-b15
    restart: always
    environment:
      - HTTP_ADDR=${LAND_RUMTIME_HTTP_ADDR}
      - STORAGE_LOCAL_PATH=/data
      - EDGE_ADDR=http://land-edge:${LAND_EDGE_HTTP_PORT}
    deploy:
      replicas: 2
    networks:
      - runtime_land_edge_network
    volumes:
      - ${LAND_RUMTIME_STORAGE_LOCAL_PATH}:/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.land-runtime.rule=Host(`${LAND_RUNTIME_DOMAIN}`)
    depends_on:
      - land-edge
